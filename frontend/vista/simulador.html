<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Simulador de Crédito</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6f6f6; margin:0; }
    .wrap { max-width: 980px; margin: 32px auto; background:#fff; border-radius:10px; padding: 20px 20px 28px; box-shadow: 0 3px 18px rgba(0,0,0,.06); }
    h1 { margin: 4px 0 16px; font-size: 22px; }
    .hello { color:#444; margin-bottom:12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 760px){ .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { font-weight: 600; font-size: 14px; margin-bottom: 6px; display:block; }
    input, select, button { width: 100%; padding: 12px; font-size: 16px; box-sizing: border-box; }
    input, select { border:1px solid #d4d4d4; border-radius:8px; background:#fff; }
    .btn { background:#d9342b; color:#fff; border:0; border-radius:10px; padding: 12px; cursor:pointer; font-weight:700; letter-spacing:.4px; }
    .panel { background:#fafafa; border:1px solid #eee; border-radius:10px; padding: 14px; margin-top:12px; }
    .row { display:flex; gap: 10px; align-items:center; justify-content:space-between; padding: 6px 0; border-bottom:1px dashed #eee; }
    .row:last-child { border-bottom:0; }
    .kpi { font-size: 18px; font-weight:700; }
    .muted { color:#666; font-size: 13px; }
    #msg { margin-top: 10px; color:#b00020; }
    #ok  { margin-top: 10px; color:#056608; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Simulador de Crédito de Consumo</h1>
    <div id="hello" class="hello"></div>

    <div class="grid grid-2">
      <div>
        <label for="monto">Monto solicitado</label>
        <input id="monto" placeholder="Ej: 4.500.000" />
      </div>
      <div>
        <label for="renta">Renta líquida mensual</label>
        <input id="renta" placeholder="Ej: 1.000.000" />
      </div>
      <div>
        <label for="cuotas">Cantidad de cuotas</label>
        <select id="cuotas">
          <option>6</option><option>12</option><option selected>24</option>
          <option>36</option><option>48</option><option>60</option>
        </select>
      </div>

      <div>
        <label>Tasa anual ofrecida</label>
        <input id="tasa" disabled placeholder="—" />
        <div class="muted">Se calcula automáticamente según tu renta, monto y plazo.</div>
      </div>
    </div>

    <div style="display:flex; gap:12px; margin: 16px 0;">
      <button id="btnSim" class="btn">Simular</button>
      <button id="btnSolicitud" class="btn" disabled>Aceptar y enviar solicitud</button>
    </div>

    <div id="msg"></div>
    <div id="ok"></div>

    <div id="resultado" class="panel" style="display:none;">
      <div class="row"><div>Cuota mensual estimada</div><div id="cuota" class="kpi">$0</div></div>
      <div class="row"><div>Total a pagar</div><div id="total">$0</div></div>
      <div class="row"><div>Intereses totales</div><div id="intereses">$0</div></div>
      <div class="row"><div>Carga (cuota/renta)</div><div id="carga" class="kpi">0%</div></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fmt = (x) => new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 }).format(Math.round(x||0));
    const parseCL = (s) => Number(String(s||'').replace(/\./g,'').replace(/,/g,'.').replace(/[^\d.-]/g,''));

    let me = null;
    let sim = null;

    // saludo con sesión
    fetch('/api/me').then(r => r.json()).then(d => {
      if (!d.user) { location.href = '/'; return; }
      me = d.user;
      $('hello').textContent = `Hola, ${me.nombre} (Cuenta ${me.numero_cuenta})`;
    });

    $('btnSim').addEventListener('click', async () => {
      $('msg').textContent = ''; $('ok').textContent = '';
      $('resultado').style.display = 'none'; $('btnSolicitud').disabled = true;

      const monto  = parseCL($('monto').value);
      const renta  = parseCL($('renta').value);
      const cuotas = Number($('cuotas').value);

      if (!isFinite(monto) || monto <= 0 || !isFinite(renta) || renta <= 0 || !isFinite(cuotas) || cuotas <= 0) {
        $('msg').textContent = 'Completa todos los campos con valores válidos.';
        return;
      }

      try {
        const resp = await fetch('/simulaciones/oferta', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ monto, renta, cuotas })
        });
        const data = await resp.json().catch(()=> ({}));
        if (!(resp.ok && data.ok)) {
          $('msg').textContent = 'No se pudo simular: ' + (data.error || `Error ${resp.status}`);
          return;
        }

        $('tasa').value = data.tasaAnual + ' %';
        $('cuota').textContent     = fmt(data.cuota);
        $('total').textContent     = fmt(data.total);
        $('intereses').textContent = fmt(data.intereses);
        $('carga').textContent     = `${(data.carga||0).toFixed(1)}%`;
        $('resultado').style.display = 'block';

        // guardamos snapshot para enviar
        sim = { monto, renta, cuotas, tasaAnual: data.tasaAnual, cuotaEstimada: Math.round(data.cuota) };
        $('btnSolicitud').disabled = false;
      } catch (err) {
        $('msg').textContent = 'Error de red: ' + err.message;
      }
    });

    $('btnSolicitud').addEventListener('click', async () => {
      if (!sim) return;
      $('msg').textContent = ''; $('ok').textContent = '';

      try {
        const resp = await fetch('/solicitudes/crear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(sim)
        });
        const data = await resp.json().catch(()=> ({}));
        if (resp.ok && data.ok) {
          $('ok').textContent = `Solicitud creada ✅\nID: ${data.idSolicitud}\nEstado: ${data.estado}`;
        } else {
          $('msg').textContent = 'No se pudo crear la solicitud: ' + (data.error || `Error ${resp.status}`);
        }
      } catch (err) {
        $('msg').textContent = 'Error de red: ' + err.message;
      }
    });
  </script>
</body>
</html>
